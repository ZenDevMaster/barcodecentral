{% extends "base.html" %}

{% block title %}Print Label - Barcode Central{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col">
            <h1 class="h2">
                <i class="bi bi-printer"></i> Print Label
            </h1>
            <p class="text-muted">Select a template and printer to print labels</p>
        </div>
    </div>

    <form id="printForm">
        <div class="row">
            <!-- Left Column: Print Configuration -->
            <div class="col-lg-5 mb-4">
                <div class="card mb-3">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">
                            <i class="bi bi-gear"></i> Print Configuration
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="templateSelect" class="form-label">Template *</label>
                            <select class="form-select" id="templateSelect" name="template_name" required>
                                <option value="">-- Select Template --</option>
                                {% for template in templates %}
                                <option value="{{ template.filename }}"
                                        {% if selected_template and selected_template.filename == template.filename %}selected{% endif %}
                                        data-filename="{{ template.filename }}"
                                        data-name="{{ template.name }}"
                                        data-variables="{{ template.variables|join(',') if template.variables else '' }}"
                                        data-width="{{ template.size.split('x')[0] if template.size and 'x' in template.size else '' }}"
                                        data-height="{{ template.size.split('x')[1] if template.size and 'x' in template.size else '' }}">
                                    {{ template.name }} ({{ template.size.split('x')[0] if template.size and 'x' in template.size else '' }}" x {{ template.size.split('x')[1] if template.size and 'x' in template.size else '' }}")
                                </option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="mb-3">
                            <label for="printerSelect" class="form-label">Printer *</label>
                            <select class="form-select" id="printerSelect" name="printer_name" required>
                                <option value="">-- Select Printer --</option>
                                {% for printer in printers %}
                                {% if printer.enabled %}
                                <option value="{{ printer.id }}"
                                        data-printer-name="{{ printer.name }}"
                                        data-sizes="{{ printer.supported_sizes|join(',') if printer.supported_sizes else '' }}">
                                    {{ printer.name }} - {{ printer.location|default('Unknown Location') }}
                                </option>
                                {% endif %}
                                {% endfor %}
                            </select>
                            <div id="printerWarning" class="alert alert-warning mt-2" style="display: none;">
                                <i class="bi bi-exclamation-triangle"></i>
                                <small id="printerWarningText"></small>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="quantity" class="form-label">Quantity *</label>
                            <input type="number" class="form-control" id="quantity" name="quantity" 
                                   min="1" max="100" value="1" required>
                            <small class="form-text text-muted">Maximum: 100 labels</small>
                        </div>
                    </div>
                </div>

                <!-- Variable Fields -->
                <div class="card" id="variablesCard" style="display: none;">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">
                            <i class="bi bi-input-cursor-text"></i> Template Variables
                        </h5>
                    </div>
                    <div class="card-body" id="variableFields">
                        <!-- Dynamic fields will be inserted here -->
                    </div>
                </div>

                <!-- Actions -->
                <div class="card mt-3">
                    <div class="card-body">
                        <button type="button" class="btn btn-info w-100 mb-2" id="previewBtn">
                            <i class="bi bi-eye"></i> Preview Only
                        </button>
                        <button type="submit" class="btn btn-success w-100 mb-2">
                            <i class="bi bi-printer-fill"></i> Print Labels
                        </button>
                        <button type="button" class="btn btn-warning w-100 mb-2" id="generatePdfBtn">
                            <i class="bi bi-file-pdf"></i> Generate PDF of Label
                        </button>
                        <a href="{{ url_for('web.dashboard') }}" class="btn btn-secondary w-100">
                            <i class="bi bi-x-circle"></i> Cancel
                        </a>
                    </div>
                </div>
            </div>

            <!-- Right Column: Preview -->
            <div class="col-lg-7">
                <div class="card sticky-top" style="top: 20px;">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0">
                            <i class="bi bi-eye"></i> Live Preview
                        </h5>
                    </div>
                    <div class="card-body text-center" style="min-height: 400px;">
                        <div id="previewPlaceholder" class="text-muted py-5">
                            <i class="bi bi-image" style="font-size: 4rem;"></i>
                            <p class="mt-3">Select a template to see preview</p>
                        </div>
                        <div id="previewLoading" style="display: none;">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-2">Generating preview...</p>
                        </div>
                        <div id="previewContent"></div>
                        <div id="previewError" class="alert alert-danger" style="display: none;"></div>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

<!-- Success Modal -->
<div class="modal fade" id="successModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">
                    <i class="bi bi-check-circle"></i> Print Job Submitted
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Your print job has been submitted successfully!</p>
                <div id="printJobDetails"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-warning" id="downloadPdfBtn" style="display: none;">
                    <i class="bi bi-file-pdf"></i> Download PDF
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <a href="{{ url_for('web.history') }}" class="btn btn-primary">View History</a>
                <button type="button" class="btn btn-success" id="printAnotherBtn">Print Another</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/print_form.js') }}"></script>

<script>
$(document).ready(function() {
    let currentTemplate = null;
    let previewDebounceTimer = null;
    let currentPreviewFilename = null;  // Track the current preview filename
    let isReprintSetup = false;  // Flag to prevent auto-preview during reprint setup

    // Template selection handler
    $('#templateSelect').on('change', function() {
        const selectedOption = $(this).find('option:selected');
        const templateName = selectedOption.val();
        
        if (!templateName) {
            $('#variablesCard').hide();
            $('#previewPlaceholder').show();
            $('#previewContent').empty();
            currentTemplate = null;
            return;
        }

        const variables = selectedOption.data('variables');
        const width = selectedOption.data('width');
        const height = selectedOption.data('height');
        const displayName = selectedOption.data('name');

        currentTemplate = {
            filename: templateName,
            name: displayName,
            variables: variables ? variables.split(',') : [],
            width: width,
            height: height
        };

        // Generate variable fields
        generateVariableFields(currentTemplate.variables);
        
        // Check printer compatibility
        checkPrinterCompatibility();
        
        // Generate initial preview (unless we're in reprint setup mode)
        if (!isReprintSetup) {
            generatePreview();
        }
    });

    // Printer selection handler
    $('#printerSelect').on('change', function() {
        checkPrinterCompatibility();
    });

    // Variable field change handler (with debounce)
    $(document).on('input', '.variable-input', function() {
        clearTimeout(previewDebounceTimer);
        previewDebounceTimer = setTimeout(() => {
            generatePreview();
        }, 500);
    });

    // Preview button
    $('#previewBtn').on('click', function() {
        generatePreview();
    });

    // PDF Generation button
    $('#generatePdfBtn').on('click', async function() {
        const templateName = $('#templateSelect').val();
        
        if (!templateName) {
            showToast('Please select a template first', 'warning');
            return;
        }
        
        const formData = {
            template: templateName,
            variables: {},
            format: 'pdf'
        };
        
        // Collect variable values
        $('.variable-input').each(function() {
            const varName = $(this).data('variable');
            formData.variables[varName] = $(this).val() || `Sample ${varName}`;
        });
        
        try {
            const $btn = $(this);
            $btn.prop('disabled', true).html('<i class="bi bi-hourglass-split"></i> Generating PDF...');
            
            const response = await fetch('/api/preview/pdf', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(formData)
            });
            
            if (response.ok) {
                const data = await response.json();
                if (data.preview_url) {
                    // Open PDF in new tab
                    window.open(data.preview_url, '_blank');
                    showToast('PDF generated successfully!', 'success');
                }
            } else {
                const data = await response.json();
                showToast('Error generating PDF: ' + (data.error || 'Unknown error'), 'danger');
            }
        } catch (error) {
            showToast('Error: ' + error.message, 'danger');
        } finally {
            $(this).prop('disabled', false).html('<i class="bi bi-file-pdf"></i> Generate PDF of Label');
        }
    });

    // Form submission
    $('#printForm').on('submit', async function(e) {
        e.preventDefault();

        const templateName = $('#templateSelect').val();
        const printerName = $('#printerSelect').val();
        
        // Find printer_id from printer name
        const printerOption = $('#printerSelect').find('option:selected');
        const printerId = printerOption.val(); // This is actually the printer name, we need to use it as-is
        
        const formData = {
            template: templateName,
            printer_id: printerId,
            quantity: parseInt($('#quantity').val()),
            variables: {},
            generate_preview: true,
            preview_filename: currentPreviewFilename  // CRITICAL: Pass existing preview to reuse it
        };
        
        // Debug logging
        console.log('[DEBUG] Print submission - currentPreviewFilename:', currentPreviewFilename);

        // Collect variable values
        $('.variable-input').each(function() {
            const varName = $(this).data('variable');
            formData.variables[varName] = $(this).val();
        });

        try {
            const response = await fetch('/api/print/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(formData)
            });

            if (response.ok) {
                const data = await response.json();
                showSuccessModal(data);
            } else {
                const data = await response.json();
                showToast(data.error || 'Failed to submit print job', 'danger');
            }
        } catch (error) {
            showToast('Error submitting print job: ' + error.message, 'danger');
        }
    });

    // Print another button
    $('#printAnotherBtn').on('click', function() {
        $('#successModal').modal('hide');
        $('#printForm')[0].reset();
        $('#variablesCard').hide();
        $('#previewContent').empty();
        $('#previewPlaceholder').show();
        currentPreviewFilename = null;  // CRITICAL: Reset preview filename for new print job
        console.log('[DEBUG] Reset currentPreviewFilename on Print Another');
    });

    // Generate variable fields
    function generateVariableFields(variables) {
        const container = $('#variableFields');
        container.empty();

        if (!variables || variables.length === 0) {
            $('#variablesCard').hide();
            return;
        }

        $('#variablesCard').show();

        variables.forEach(varName => {
            const fieldHtml = `
                <div class="mb-3">
                    <label for="var_${varName}" class="form-label">${varName}</label>
                    <input type="text" class="form-control variable-input" 
                           id="var_${varName}" data-variable="${varName}"
                           placeholder="Enter ${varName}">
                </div>
            `;
            container.append(fieldHtml);
        });
    }

    // Check printer compatibility
    function checkPrinterCompatibility() {
        if (!currentTemplate) return;

        const selectedPrinter = $('#printerSelect').find('option:selected');
        const printerSizes = selectedPrinter.data('sizes');
        
        if (!printerSizes) return;

        const templateSize = `${currentTemplate.width}x${currentTemplate.height}`;
        const supportedSizes = printerSizes.split(',');

        if (!supportedSizes.includes(templateSize)) {
            $('#printerWarningText').text(
                `Warning: This printer may not support ${templateSize}" labels. Supported sizes: ${supportedSizes.join(', ')}`
            );
            $('#printerWarning').show();
        } else {
            $('#printerWarning').hide();
        }
    }

    // Generate preview
    async function generatePreview() {
        if (!currentTemplate) return;

        $('#previewPlaceholder').hide();
        $('#previewLoading').show();
        $('#previewContent').empty();
        $('#previewError').hide();

        const variables = {};
        $('.variable-input').each(function() {
            const varName = $(this).data('variable');
            const value = $(this).val() || `Sample ${varName}`;
            variables[varName] = value;
        });

        try {
            const response = await fetch('/api/preview/template', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    template_name: currentTemplate.filename,
                    variables: variables
                })
            });

            if (response.ok) {
                const data = await response.json();
                if (data.preview_url) {
                    // Store the preview filename for reuse during print
                    currentPreviewFilename = data.filename;
                    $('#previewContent').html(`
                        <img src="${data.preview_url}" class="img-fluid" alt="Label Preview"
                             style="max-width: 100%; border: 1px solid #ddd; border-radius: 5px;">
                    `);
                }
            } else {
                const data = await response.json();
                $('#previewError').text(data.error || 'Failed to generate preview').show();
            }
        } catch (error) {
            $('#previewError').text('Error: ' + error.message).show();
        } finally {
            $('#previewLoading').hide();
        }
    }

    // Show success modal
    function showSuccessModal(data) {
        const details = `
            <ul class="list-unstyled">
                <li><strong>Template:</strong> ${data.template || 'N/A'}</li>
                <li><strong>Printer:</strong> ${data.printer || 'N/A'}</li>
                <li><strong>Quantity:</strong> ${data.quantity || 1}</li>
                <li><strong>Status:</strong> <span class="badge bg-success">Success</span></li>
            </ul>
        `;
        $('#printJobDetails').html(details);
        
        // Setup PDF download button if preview was generated
        if (data.preview_url) {
            // Generate PDF URL by requesting PDF format for the same template/variables
            $('#downloadPdfBtn').show().off('click').on('click', async function() {
                try {
                    const $btn = $(this);
                    $btn.prop('disabled', true).html('<i class="bi bi-hourglass-split"></i> Generating...');
                    
                    // Collect current variables
                    const variables = {};
                    $('.variable-input').each(function() {
                        const varName = $(this).data('variable');
                        variables[varName] = $(this).val();
                    });
                    
                    const response = await fetch('/api/preview/pdf', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            template: data.template,
                            variables: variables,
                            format: 'pdf'
                        })
                    });
                    
                    if (response.ok) {
                        const pdfData = await response.json();
                        if (pdfData.preview_url) {
                            window.open(pdfData.preview_url, '_blank');
                        }
                    } else {
                        showToast('Error generating PDF', 'danger');
                    }
                } catch (error) {
                    showToast('Error: ' + error.message, 'danger');
                } finally {
                    $(this).prop('disabled', false).html('<i class="bi bi-file-pdf"></i> Download PDF');
                }
            });
        } else {
            $('#downloadPdfBtn').hide();
        }
        
        $('#successModal').modal('show');
    }

    // Toast notification helper
    function showToast(message, type = 'info') {
        // Simple alert for now - can be enhanced with Bootstrap toast
        const alertClass = type === 'success' ? 'alert-success' :
                          type === 'danger' ? 'alert-danger' :
                          type === 'warning' ? 'alert-warning' : 'alert-info';
        
        const toast = $(`
            <div class="alert ${alertClass} alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3"
                 role="alert" style="z-index: 9999; min-width: 300px;">
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        `);
        
        $('body').append(toast);
        setTimeout(() => toast.alert('close'), 5000);
    }

    // Handle reprint data from sessionStorage FIRST (before URL template)
    console.log('[REPRINT] Checking for reprint data in sessionStorage...');
    const reprintDataStr = sessionStorage.getItem('reprintData');
    console.log('[REPRINT] SessionStorage content:', reprintDataStr);
    let isReprinting = false;
    
    if (reprintDataStr) {
        try {
            const reprintData = JSON.parse(reprintDataStr);
            console.log('[REPRINT] Loading reprint data:', reprintData);
            isReprinting = true;
            isReprintSetup = true;  // Set flag to prevent auto-preview
            
            // Clear sessionStorage immediately to prevent reuse
            sessionStorage.removeItem('reprintData');
            
            // Auto-select template (use filename, not display name)
            if (reprintData.template) {
                $('#templateSelect').val(reprintData.template).trigger('change');
            }
            
            // Wait for template to load and variable fields to be generated
            setTimeout(() => {
                // Auto-select printer
                if (reprintData.printerId) {
                    $('#printerSelect').val(reprintData.printerId);
                    console.log('[REPRINT] Selected printer:', reprintData.printerId);
                }
                
                // Auto-populate quantity
                if (reprintData.quantity) {
                    $('#quantity').val(reprintData.quantity);
                }
                
                // Auto-populate variable fields
                console.log('[REPRINT] About to populate variables...');
                console.log('[REPRINT] reprintData.variables:', reprintData.variables);
                console.log('[REPRINT] Type:', typeof reprintData.variables);
                console.log('[REPRINT] Is object?:', typeof reprintData.variables === 'object');
                console.log('[REPRINT] Is truthy?:', !!reprintData.variables);
                
                if (reprintData.variables && typeof reprintData.variables === 'object') {
                    const varKeys = Object.keys(reprintData.variables);
                    console.log('[REPRINT] Variable keys:', varKeys);
                    console.log('[REPRINT] Number of variables:', varKeys.length);
                    
                    varKeys.forEach(varName => {
                        const fieldId = `var_${varName}`;
                        const $field = $(`#${fieldId}`);
                        const value = reprintData.variables[varName];
                        
                        console.log(`[REPRINT] Processing ${varName}:`);
                        console.log(`  - Field ID: ${fieldId}`);
                        console.log(`  - Field exists: ${$field.length > 0}`);
                        console.log(`  - Value: ${value}`);
                        
                        if ($field.length) {
                            $field.val(value);
                            console.log(`  ✓ Set ${varName} = ${value}`);
                        } else {
                            console.warn(`  ✗ Field not found: ${fieldId}`);
                            // List all variable input fields that DO exist
                            const existingFields = $('.variable-input').map(function() {
                                return $(this).attr('id');
                            }).get();
                            console.warn(`  Available fields:`, existingFields);
                        }
                    });
                } else {
                    console.error('[REPRINT] Variables not valid:', {
                        variables: reprintData.variables,
                        type: typeof reprintData.variables,
                        isObject: typeof reprintData.variables === 'object',
                        isTruthy: !!reprintData.variables
                    });
                }
                
                // Try to load existing preview
                setTimeout(() => {
                    console.log('[REPRINT] Preview filename from history:', reprintData.previewFilename);
                    console.log('[REPRINT] isReprintSetup flag:', isReprintSetup);
                    
                    // Try to load existing preview if available
                    if (reprintData.previewFilename) {
                        console.log('[REPRINT] Attempting to load existing preview:', reprintData.previewFilename);
                        const previewUrl = `/api/preview/${reprintData.previewFilename}`;
                        console.log('[REPRINT] Preview URL:', previewUrl);
                        
                        // Try to load the image directly
                        const img = new Image();
                        
                        img.onload = function() {
                            console.log('[REPRINT] ✓ Existing preview loaded successfully');
                            currentPreviewFilename = reprintData.previewFilename;
                            $('#previewPlaceholder').hide();
                            $('#previewLoading').hide();
                            $('#previewContent').html(`
                                <img src="${previewUrl}" class="img-fluid" alt="Label Preview"
                                     style="max-width: 100%; border: 1px solid #ddd; border-radius: 5px;">
                            `);
                            isReprintSetup = false;  // Clear flag after successful load
                        };
                        
                        img.onerror = function() {
                            console.log('[REPRINT] ✗ Existing preview not found or failed to load, generating new one');
                            isReprintSetup = false;  // Clear flag before generating
                            generatePreview();
                        };
                        
                        img.src = previewUrl;
                    } else {
                        console.log('[REPRINT] No preview filename provided, generating new preview');
                        isReprintSetup = false;  // Clear flag before generating
                        generatePreview();
                    }
                }, 200);
            }, 600);
            
        } catch (error) {
            console.error('[REPRINT] Error loading reprint data:', error);
            showToast('Error loading reprint data', 'danger');
            isReprinting = false;
        }
    }
    
    // Auto-select template if provided in URL (only if not reprinting)
    {% if selected_template %}
    if (!isReprinting) {
        $('#templateSelect').val('{{ selected_template.name }}').trigger('change');
    }
    {% endif %}
});
</script>
{% endblock %}