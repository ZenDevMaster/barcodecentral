# Headscale UI Integration - Final Implementation Plan

## Problem Identified

When accessing `domain.com/headscale-admin`, the request was being redirected to `https://barcode.zendrian.com/app/login` instead of proxying to the Headscale UI container.

## Root Causes

### 1. **Port Exposure Issue** ✅ FIXED
**Problem:** The headscale-ui container only used `expose: 3000` instead of `ports: 3000:3000`
- `expose` only makes the port available within the Docker network
- External nginx (running on host) cannot reach `localhost:3000`
- Traefik can access it via Docker network, but nginx cannot

**Solution:** Changed to `ports: - "3000:3000"` in setup.sh line 760

### 2. **Traefik Priority Issue** ✅ FIXED
**Problem:** The `/headscale-admin` route might be caught by the main app route
- Without explicit priority, Traefik may route to the wrong service
- The `PathPrefix` needs proper configuration

**Solution:** Added priority and improved middleware configuration:
- Added `priority=100` to ensure headscale-ui route is matched first
- Added `forceSlash=false` to stripprefix middleware
- This ensures `/headscale-admin` is handled before the main app's `/` route

### 3. **Flask 404 Handler** ✅ ENHANCED
**Problem:** If requests reach Flask (misconfiguration), they get redirected to login
- Flask's 404 handler doesn't distinguish between app routes and proxy routes

**Solution:** Added diagnostic logging to identify when Flask receives `/headscale-admin` requests
- This helps identify reverse proxy misconfigurations
- Logs full request details for debugging

## Implementation Details

### Changes Made

#### 1. `setup.sh` - Line 740-770 (headscale-ui service)
```yaml
# Changed from:
expose:
  - "3000"

# To:
ports:
  - "3000:3000"
```

**Why:** Allows external nginx to access the container on localhost:3000

#### 2. `setup.sh` - Line 819-840 (Traefik labels)
```yaml
# Added:
- "traefik.http.routers.headscale-ui.priority=100"
- "traefik.http.middlewares.headscale-ui-stripprefix.stripprefix.forceSlash=false"
```

**Why:** 
- Priority ensures `/headscale-admin` is matched before `/`
- forceSlash=false handles both `/headscale-admin` and `/headscale-admin/` correctly

#### 3. `app.py` - Line 94-115 (404 handler)
```python
# Added diagnostic logging for /headscale-admin requests
if request_path.startswith('/headscale-admin'):
    logger.error(f"Flask received /headscale-admin request - reverse proxy misconfiguration!")
```

**Why:** Helps identify when reverse proxy is not properly configured

### Nginx Configuration (Already Correct)

The nginx configuration generated by setup.sh (lines 988-1014) is already correct:
```nginx
location /headscale-admin/ {
    proxy_pass http://localhost:3000/;
    proxy_set_header X-Script-Name /headscale-admin;
    # ... other headers
}
```

This will now work because:
1. Port 3000 is exposed on the host
2. nginx can reach localhost:3000
3. The location block properly strips the prefix and forwards to the UI

## Deployment Scenarios

### Scenario 1: Traefik (Docker-based)
**How it works:**
1. Traefik receives request to `domain.com/headscale-admin`
2. Matches rule with priority 100 (higher than main app)
3. Routes to headscale-ui container via Docker network
4. Strips `/headscale-admin` prefix
5. Adds `X-Script-Name` header for subfolder support

**Configuration:** Automatic via docker-compose labels

### Scenario 2: Nginx (External)
**How it works:**
1. Nginx receives request to `domain.com/headscale-admin/`
2. Matches location block
3. Proxies to `localhost:3000` (now accessible via ports mapping)
4. Strips `/headscale-admin` prefix
5. Adds `X-Script-Name` header

**Configuration:** Generated in `config/nginx/barcode-central.conf`

### Scenario 3: Direct Access (Development)
**How it works:**
1. Access `http://localhost:3000` directly
2. No prefix stripping needed
3. Direct connection to headscale-ui

**Configuration:** Port 3000 exposed on host

## Testing the Fix

### For Traefik Users:
```bash
# 1. Regenerate docker-compose.yml
./setup.sh

# 2. Restart services
docker compose down
docker compose up -d

# 3. Check Traefik routing
docker compose logs traefik | grep headscale-ui

# 4. Test access
curl -I https://your-domain.com/headscale-admin/
# Should return 200 or 401 (auth required), NOT 404
```

### For Nginx Users:
```bash
# 1. Regenerate configuration
./setup.sh

# 2. Deploy nginx config
sudo cp config/nginx/barcode-central.conf /etc/nginx/sites-available/barcode-central
sudo ln -sf /etc/nginx/sites-available/barcode-central /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl reload nginx

# 3. Restart Docker services
docker compose down
docker compose up -d

# 4. Test access
curl -I http://your-domain.com/headscale-admin/
# Should return 200 or 401 (auth required), NOT 404
```

### Diagnostic Commands:
```bash
# Check if headscale-ui is running
docker ps | grep headscale-ui

# Check if port 3000 is exposed
docker port headscale-ui

# Check if you can reach the UI from host
curl -I http://localhost:3000/

# Check Flask logs for /headscale-admin requests (should be empty)
docker compose logs app | grep headscale-admin

# Check Traefik routing (if using Traefik)
docker compose exec traefik cat /etc/traefik/traefik.yml
```

## Migration Guide

### For Existing Deployments:

1. **Backup current configuration:**
   ```bash
   cp docker-compose.yml docker-compose.yml.backup
   cp .env .env.backup
   ```

2. **Update setup.sh:**
   ```bash
   git pull  # or manually update setup.sh with the fixes
   ```

3. **Regenerate configuration:**
   ```bash
   ./setup.sh
   # Answer prompts to regenerate docker-compose.yml
   ```

4. **Review changes:**
   ```bash
   diff docker-compose.yml.backup docker-compose.yml
   # Verify headscale-ui now has ports instead of expose
   # Verify Traefik labels include priority=100
   ```

5. **Apply changes:**
   ```bash
   docker compose down
   docker compose up -d
   ```

6. **Verify:**
   ```bash
   # Test the /headscale-admin endpoint
   curl -I https://your-domain.com/headscale-admin/
   ```

## Summary

### What Was Fixed:
1. ✅ headscale-ui port exposure (expose → ports)
2. ✅ Traefik routing priority (added priority=100)
3. ✅ Traefik stripprefix configuration (added forceSlash=false)
4. ✅ Flask diagnostic logging (identify misconfigurations)

### What Was Already Correct:
- ✅ Nginx location block configuration
- ✅ Docker networking setup
- ✅ Environment variables and credentials
- ✅ Headscale UI container configuration

### Expected Behavior After Fix:
- **Traefik:** `https://domain.com/headscale-admin` → headscale-ui (via Docker network)
- **Nginx:** `http://domain.com/headscale-admin/` → localhost:3000 → headscale-ui
- **Direct:** `http://localhost:3000` → headscale-ui
- **Flask:** Should NEVER receive `/headscale-admin` requests (logged if it does)

## Troubleshooting

### Issue: Still getting 404
**Check:**
1. Is headscale-ui container running? `docker ps | grep headscale-ui`
2. Is port exposed correctly? `docker port headscale-ui` (should show 3000->3000 or custom port)
3. Can you reach it directly? `curl http://localhost:3009/` (use your actual port)
4. Check Flask logs: `docker compose logs app | grep headscale-admin`
5. Verify nginx config: `cat /etc/nginx/sites-enabled/barcode-central | grep headscale-admin`

### Issue: Getting 502 Bad Gateway ⚠️ COMMON ISSUE
**This is the most common issue!** 502 means nginx can reach headscale-ui, but headscale-ui cannot reach the headscale backend.

**Run the diagnostic script:**
```bash
./diagnose_headscale_ui_502.sh
```

**Most likely causes:**
1. **HEADSCALE_API_KEY not set** (90% of cases)
   ```bash
   # Generate API key
   docker compose exec headscale headscale apikeys create
   
   # Add to .env file
   echo "HEADSCALE_API_KEY=your-generated-key-here" >> .env
   
   # Restart headscale-ui
   docker compose restart headscale-ui
   ```

2. **Headscale container is unhealthy**
   ```bash
   # Check status
   docker compose ps headscale
   
   # Check logs
   docker compose logs headscale
   
   # Common fix: restart headscale
   docker compose restart headscale
   ```

3. **Network connectivity issue**
   ```bash
   # Test if headscale-ui can reach headscale
   docker compose exec headscale-ui curl http://headscale:8080/health
   
   # Should return: {"status":"ok"}
   # If not, check Docker networks
   docker network ls
   docker network inspect barcode-network
   docker network inspect headscale-network
   ```

4. **Wrong HS_SERVER environment variable**
   ```bash
   # Check what headscale-ui is configured to use
   docker compose exec headscale-ui env | grep HS_SERVER
   
   # Should be: HS_SERVER=http://headscale:8080
   # If wrong, fix in docker-compose.yml and restart
   ```

**Step-by-step fix for 502:**
```bash
# 1. Check if headscale is healthy
docker compose ps

# 2. If headscale is unhealthy, check logs
docker compose logs headscale

# 3. Generate API key if missing
docker compose exec headscale headscale apikeys create

# 4. Add API key to .env
nano .env
# Add line: HEADSCALE_API_KEY=your-key-here

# 5. Restart headscale-ui
docker compose restart headscale-ui

# 6. Wait 10 seconds and test
sleep 10
curl -I http://localhost:3009/

# 7. Check logs
docker compose logs headscale-ui
```

### Issue: Authentication not working
**Check:**
1. Are credentials set? `grep HEADSCALE_UI .env`
2. Try credentials from `.env` file
3. Check container logs: `docker compose logs headscale-ui`
4. Verify AUTH_TYPE is set: `docker compose exec headscale-ui env | grep AUTH_TYPE`

## Next Steps

1. Run `./setup.sh` to regenerate configuration with fixes
2. Deploy updated docker-compose.yml
3. Test `/headscale-admin` access
4. Generate Headscale API key if needed: `./scripts/generate-headscale-api-key.sh`
5. Update `.env` with API key
6. Restart headscale-ui: `docker compose restart headscale-ui`